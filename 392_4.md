# 392.4 Sambaのトラブルシューティング

## ログ関連のsmb.confパラメータ

| パラメータ               | 値             | 説明                                                 |
|:-------------------------|:---------------|:-----------------------------------------------------|
| log file                 | ファイルパス   | Sambaが利用するログファイルを指定                    |
| log level<br>debug level | 0-10           | 出力ログレベルを設定<br>値が大きいほど詳細           |
| max log size             | KB単位のサイズ | ログファイルの最大サイズを指定                       |
| debug timestamp          | yes/no         | ログファイルに時刻を出力するか指定                   |
| debug hires timestamp    | yes/no         | ログファイルの時刻を秒単位にするか指定               |
| debug pid                | yes/no         | ログファイルにPIDを出力するか指定                    |
| debug uid                | yes/no         | ログファイルにUIDを出力するか指定                    |
| eventlog list            | イベントログ名 | SambaログをWindowsのイベントビューアから参照する機能 |
| syslog                   | 0-10           | syslog に出力するログレベルを設定する                |
| syslog only              | yes/no         | `yes`の場合、syslogにのみログが出力される            |

### ログ出力例

```
$ cat /usr/local/samba/var/log.smbd
[2018/02/16 09:29:27.071827,  0] ../lib/util/become_daemon.c:124(daemon_ready)
  STATUS=daemon 'smbd' finished starting up and ready to serve connections
```

## smbpasswd コマンド

[smbpasswd](http://www.samba.gr.jp/project/translation/4.6/htmldocs/manpages/smbpasswd.8.html)

`smbpasswd`は、ユーザのSMBパスワードを変更するコマンド<br>
Linux上では、暗号化されたSMBパスワードは`smbpasswd`ファイルに保持される

* 書式

```
smbpasswd [ユーザ名]
```

* オプション

| オプション               | 説明                                                                                 |
|:-------------------------|:-------------------------------------------------------------------------------------|
| -U <ユーザ名>[%password] | パスワード変更対象のリモートマシン上のユーザ名を指定<br>`-r`オプションと共に利用する |
| -r <NetBIOS名>           | 変更したいパスワードがあるリモートマシンを指定                                       |
| -a                       | 指定したユーザをSMBユーザとして新規登録                                              |
| -x                       | 指定したユーザをSMBユーザから削除                                                    |
| -e                       | 指定したユーザを有効化                                                               |
| -d                       | 指定したユーザを無効化                                                               |
| -n                       | 指定したユーザを「パスワードなし」にする                                             |
| -m                       | パスワード変更対象のアカウントがマシンアカウントであることを指示                     |
| -i                       | パスワード変更対象のアカウントがドメイン間信頼ドメインであることを指示               |
| -s                       | 変更パスワードを対話的ではなく標準入力から受け付ける                                 |
| -w <password>            | `ldap_admin_dn`に使用するパスワードを変更                                            |
| -W                       | -w オプションの<password>を標準入力から受け付ける                                    |
| -c <ファイルパス>        | 設定ファイルを指定                                                                   |
| -R <サービス名>          | NetBIOS名の名前解決サービスを指定<br>サービス名は`lmhosts`、`host`、`wins`、`bcast`  |
| -L                       | ローカルモードで起動                                                                 |

* smbpasswd形式

[smbpasswd - ファイル形式](http://www.samba.gr.jp/project/translation/4.6/htmldocs/manpages/smbpasswd.5.html#idm139906780807984)

```
<UNIXユーザ名>:<UID>:<Lanmanパスワード(Windows 95/58)>:<NTドメインパスワード>:<アカウント属性>:<最終更新日時(UNIX時間)>
```

## pdbedit コマンド

[pdbedit](http://www.samba.gr.jp/project/translation/4.6/htmldocs/manpages/pdbedit.8.html)

`pdbedit`は、SAMデータベースを管理するコマンド<br>
ユーザアカウントの追加、削除、変更、一覧表示、取り込みが行える<br>
ユーザパスワードの変更はできないため、変更したい場合は`smbpasswd`コマンドを使用する

* 書式

```
pdbedit [オプション]
```

* オプション(表示)

| オプション      | 説明                                                               |
|:----------------|:-------------------------------------------------------------------|
| -L              | ユーザアカウントの一覧表示                                         |
| -w              | smbpasswd形式で一覧表示<br>`-L`オプションと組み合わせて使用        |
| -v              | ユーザアカウント一覧の詳細表示<br>`-L`オプションと組み合わせて使用 |
| -u <ユーザ名>   | 表示するユーザを指定                                               |
| -P <ポリシー>   | アカウントポリシーを表示                                           |

* オプション(追加、削除、変更)

| オプション            | 説明                                                         |
|:----------------------|:-------------------------------------------------------------|
| -u <ユーザ名>         | 操作するユーザを指定                                         |
| -a                    | ユーザを追加                                                 |
| -x                    | ユーザを削除                                                 |
| -m                    | コンピュータ信頼アカウントを追加                             |
| -f <フルネーム>       | ユーザのフルネームを指定                                     |
| -h <ディレクトリパス> | ユーザのホームディレクトリパスを指定                         |
| -D <ドライブ>         | ホームディレクトリのWindows ドライブ名を指定                 |
| -p <ディレクトリパス> | ユーザのプロファイルパスを指定                               |
| -S <ファイルパス>     | ユーザのログオンスクリプトを指定                             |
| -G <SID/rid>          | ユーザのプライマリグループのSID または RIDを指定             |
| -U <SID/rid>          | ユーザのSID または RIDを指定                                 |
| -c <制御プロパティ>   | ユーザのアカウント制御プロパティを指定                       |
| -K<br>--kickoff-time  | ユーザのkickoff時間を指定                                    |
| -C <ポリシー値>       | アカウントポリシーを設定<br>`-P`オプションと組み合わせて使用 |

* -c オプションで指定する制御プロパティ

| プロパティ | 意味                           |
|:-----------|:-------------------------------|
| [N]        | パスワード不要                 |
| [D]        | アカウント無効                 |
| [H]        | ホームディレクトリ必須         |
| [T]        | 一時的に他アカウントと重複     |
| [U]        | 通常のユーザアカウント         |
| [M]        | MNS ログオン用ユーザアカウント |
| [W]        | コンピュータ信頼アカウント     |
| [S]        | サーバ信頼アカウント           |
| [L]        | 自動ロック                     |
| [X]        | 無期限パスワード               |
| [I]        | ドメイン信頼アカウント         |

* オプション(取り込み)

| オプション                  | 説明                                                         |
|:----------------------------|:-------------------------------------------------------------|
| -i <データベースファイル>   | 指定したパスワードデータベースからユーザ情報を取り込み       |
| -e <データベースファイル>   | 指定したパスワードデータベースへ全ユーザデータをエクスポート |
| -b <データベースファイル>   | パスワードデータベースを指定                                 |
| -t<br>--password-from-stdin | パスワードを標準入力から読み取り                             |
| -g                          | 取り込み/エクスポート対象をグループマッピングに設定          |
| -y                          | 取り込み/エクスポート対象をアカウントポリシーに設定          |

## tdbbackup コマンド

[tdbbackup](http://www.samba.gr.jp/project/translation/3.6/htmldocs/manpages-3/tdbbackup.8.html)<br>

`tdbbackup`は、tdbファイルのバックアップや整合性の確認を行うコマンド<br>
Samba稼働中であってもバックアップを取得することが可能<br>

* 書式

```
tdbbackup <tdbファイル>
```

* オプション

| オプション | 説明                                                      |
|:-----------|:----------------------------------------------------------|
| -v         | データベースの破損を検証、復元                            |
| -s suffix  | バックアップファイルの拡張子を設定<br>既定の拡張子は .bak |

## tdbdump コマンド

[tdbdump](http://www.samba.gr.jp/project/translation/3.6/htmldocs/manpages-3/tdbdump.8.html)<br>
[TDB (Trivial DataBase) ファイルの内容を確認する｜Linux Tips](https://www.linuxmaster.jp/linux_skill/2016/11/tdb-trivial-database.html)

`tdbdump`は、TDBファイルの中身を表示するコマンド<br>

* 書式

```
tdbdump <ファイル名>
```

* オプション

| オプション | 説明                          |
|:-----------|:------------------------------|
| -k key     | 指定した key の値をダンプする |

* コマンド実行例

```
# tdbdump /var/lib/samba/winbindd_cache.tdb
 {
 key(13) = "SN/S-1-22-1-0"
 data(35) = "\00\00\00\00\942\18X\C03\18X\00\00\00\00\01\00\00\00\09UNIX USER\04root"
 }
 {
 key(15) = "SN/S-1-5-32-545"
 data(34) = "\00\00\00\00\942\18X\C03\18X\00\00\00\00\04\00\00\00\07BUILTIN\05Users"
 }
 {
 key(46) = "SN/S-1-5-21-1581974969-702731495-892098809-501"
 data(33) = "\00\00\00\00\942\18X\C03\18X\00\00\00\00\01\00\00\00\05TIGER\06nobody"
 }
 {
 key(10) = "SN/S-1-5-2"
 data(41) = "\00\00\00\00\942\18X\C03\18X\00\00\00\00\05\00\00\00\0CNT Authority\07Network"
 }
 {
 key(15) = "SN/S-1-5-32-546"
 data(35) = "\00\00\00\00\942\18X\C03\18X\00\00\00\00\04\00\00\00\07BUILTIN\06Guests"
```

## tdbrestore コマンド

[tdbrestore](https://linux.die.net/man/8/tdbrestore)

`tdbrestore`は、`tdbdump`の出力結果からTDBファイルを復元するコマンド<br>
`tdbdump`の出力結果は標準入力で与える<br>

* 書式

```
tdbrestore <tdbファイル>
```

## tdbtool コマンド

[tdbtool](http://www.samba.gr.jp/project/translation/3.6/htmldocs/manpages-3/tdbtool.8.html)

`tdbtool`は、TDBファイルを操作するコマンド<br>
コマンド引数で操作コマンドが指定されなかった場合は対話的に動作する

* 書式

```
tdbtool <TDBファイル> [操作コマンド]
```

* 操作コマンド

| コマンド                | 説明                                                       |
|:------------------------|:-----------------------------------------------------------|
| create <DBファイル>     | データベースを生成                                         |
| open <DBファイル>       | 指定したデータベースを読込                                 |
| erase                   | 現在のデータベースを消去                                   |
| dump                    | 現在のデータベースをダンプ                                 |
| keys                    | 現在のデータベースのキーをダンプ                           |
| hexkeys                 | 現在のデータベースのキーを16進数でダンプ                   |
| info                    | 現在のデータベースの概要を表示                             |
| insert <KEY> <VAL>      | 現在のデータベースに挿入                                   |
| move <KEY> <DBファイル> | 対象のレコードを指定DBファイルに移動                       |
| store <KEY> <VAL>       | 現在のデータベースにレコードを格納                         |
| show <KEY>              | 指定した KEY のレコードを表示                              |
| delete <KEY>            | 指定した KEY のレコードを削除                              |
| list                    | 現在のデータベースのハッシュテーブルと空き領域リストを表示 |
| free                    | 現在のデータベースの概要と空き領域リストを表示             |
| check                   | 現在のデータベースの整合性を検査                           |
